C51 COMPILER V9.01   MASTER_SIF                                                            01/07/2015 10:00:17 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE MASTER_SIF
OBJECT MODULE PLACED IN .\obj\master_sif.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE master_sif.c BROWSE DEBUG OBJECTEXTEND PRINT(.\lst\master_sif.lst) OBJECT(.
                    -\obj\master_sif.obj)

line level    source

   1          //************************************************************
   2          //  Copyright (c) 深圳市赛元微电子有限公司
   3          //      文件名称        : master_8_1.c
   4          //      作者            : 
   5          //      模块功能        : SIF master 8+1基础通讯模块
   6          //      局部函数列表:
   7          //  最后更正日期:
   8          //      版本            :
   9          //      更改记录        :
  10          //*************************************************************
  11          #include "H\SC91F831_C.H"
  12          #include "master_sif.H"
  13          #include "config.h"
  14          
  15          
  16          //*************************************************************
  17          // 函数名       ：void sif_init(void)
  18          // 作者         ：
  19          // 功能         ：sif初始化
  20          // 参数         ：无
  21          // 返回值       ：无
  22          // 调用全局变量：无
  23          // 修改全局变量：无
  24          // 备注         ：
  25          //**************************************************************
  26          void sif_init(void)
  27          {
  28   1              P1CFG1 &= 0x0F;         //设置P16、P17状态为准双向模式
  29   1              P1 |= 0xC0;         //设置P16、P17输出高
  30   1              SIFCFG = SIF_MASTER_ACK;  //选择SIF主8+1通讯模式
  31   1              SIFCFG |= 0x80;         //打开SIF       
  32   1      }
  33          
  34          //*************************************************************
  35          // 函数名       ：void send_start(void)
  36          // 作者         ：
  37          // 功能         ：主发送start
  38          // 参数         ：无
  39          // 返回值       ：无
  40          // 调用全局变量：无
  41          // 修改全局变量：无
  42          // 备注         ：
  43          //**************************************************************
  44          void send_start(void)
  45          {
  46   1              SIFCTL = 0x01;                  //发送start
  47   1              while(STRIF == 0);              //完成start,该bit硬件置1
  48   1              STRIF = 0;                              //清除send start完成标志        
  49   1      }
  50          
  51          //*************************************************************
  52          // 函数名       ：void send_stop(void)
  53          // 作者         ：
  54          // 功能         ：主发送stop
C51 COMPILER V9.01   MASTER_SIF                                                            01/07/2015 10:00:17 PAGE 2   

  55          // 参数         ：无
  56          // 返回值       ：无
  57          // 调用全局变量：无
  58          // 修改全局变量：无
  59          // 备注         ：
  60          //**************************************************************
  61          void send_stop(void)
  62          {
  63   1              SIFCTL = 0x00;                  //发送stop
  64   1              while(STPIF == 0);              //完成stop,该bit硬件置1
  65   1              STPIF = 0;                              //清除send stop完成标志 
  66   1      }
  67          
  68          //*************************************************************
  69          // 函数名       ：void send_byte(unsigned char sif_send_byte)
  70          // 作者         ：
  71          // 功能         ：主发送 1 byte的数据
  72          // 参数         ：unsigned char sif_send_byte
  73          // 返回值       ：无
  74          // 调用全局变量：无
  75          // 修改全局变量：无
  76          // 备注         ：
  77          //**************************************************************
  78          void send_byte(unsigned char sif_send_byte)
  79          {
  80   1              SIFTXD = sif_send_byte;
  81   1              SIFCTL = 0x02;                  //发送数据
  82   1              while(TXIF == 0);               //完成发送,该bit硬件置1
  83   1              TXIF = 0;                               //清除发送完成标志      
  84   1      }
  85          
  86          //*************************************************************
  87          // 函数名       ：void send_byte(unsigned char sif_send_byte)
  88          // 作者         ：
  89          // 功能         ：主接收 1 byte的数据
  90          // 参数         ：无
  91          // 返回值       ：unsigned char SIFRXD
  92          // 调用全局变量：无
  93          // 修改全局变量：无
  94          // 备注         ：
  95          //**************************************************************
  96          unsigned char receive_byte(void)
  97          {
  98   1              
  99   1              SIFCTL = 0x03;                  //接受数据
 100   1              while(RXIF == 0);               //完成接受,该bit硬件置1
 101   1              RXIF = 0;                               //清除接受完成标志
 102   1              return (SIFRXD);            //读取接收的数据
 103   1      }
 104          
 105          //*************************************************************
 106          // 函数名       ：bit  sif_waitack(void)
 107          // 作者         ：
 108          // 功能         ：读从发来的ACK
 109          // 参数         ：无
 110          // 返回值       ：1/0
 111          // 调用全局变量：无
 112          // 修改全局变量：无
 113          // 备注         ：返回1,有ack;返回0,无ack
 114          //**************************************************************
 115          bit  sif_waitack(void)
 116          {
C51 COMPILER V9.01   MASTER_SIF                                                            01/07/2015 10:00:17 PAGE 3   

 117   1              return (!RTNACK);       
 118   1      }
 119          
 120          //*************************************************************
 121          // 函数名       ：void  sif_ack(void)
 122          // 作者         ：
 123          // 功能         ：发送应答信号
 124          // 参数         ：无
 125          // 返回值       ：无
 126          // 调用全局变量：无
 127          // 修改全局变量：无
 128          // 备注         ：
 129          //**************************************************************
 130          void  sif_ack(void)
 131          {
 132   1              SIFCFG &= ~0x01;                                //发送应答
 133   1      }
 134          
 135          //*************************************************************
 136          // 函数名       ：void  sif_noack(void)
 137          // 作者         ：
 138          // 功能         ：发送无应答信号
 139          // 参数         ：无
 140          // 返回值       ：无
 141          // 调用全局变量：无
 142          // 修改全局变量：无
 143          // 备注         ：
 144          //**************************************************************
 145          void  sif_noack(void)
 146          {
 147   1              SIFCFG |= 0x01;                                  //发送无应答
 148   1      }
 149          
 150          
 151          
 152          //********************************************************************************************************
             -**************
 153          //********************************************************************************************************
             -**************
 154          //********************************************************************************************************
             -**************
 155          //********************************************************************************************************
             -**************
 156          
 157          //************************************************************
 158          //  Copyright (c) 深圳市赛元微电子有限公司
 159          //      文件名称        : master_8_1.c
 160          //      作者            : 
 161          //      模块功能        : SIF master 8+1读写通讯
 162          //      局部函数列表:
 163          //  最后更正日期:
 164          //      版本            :
 165          //      更改记录        : SIF master (单）多字节写，slaver无响应,进入stop
 166          //*************************************************************
 167          
 168          
 169          //******************************************************************
 170          // 函数名       ：void I2C_Usdelay(unsigned int delay)
 171          // 作者         ：
 172          // 功能         ：通信延时函数
 173          // 参数         ：无
 174          // 返回值       ：无
C51 COMPILER V9.01   MASTER_SIF                                                            01/07/2015 10:00:17 PAGE 4   

 175          // 调用全局变量：无
 176          // 修改全局变量：无
 177          // 备注         ：
 178          //******************************************************************
 179          void I2C_Usdelay(unsigned int delay)
 180          {
 181   1              while(delay)
 182   1              {
 183   2                      delay--;
 184   2              }
 185   1      }
 186          
 187          //*************************************************************
 188          // 函数名       ：void Sif_Write_N_Byte(void)
 189          // 作者         ：
 190          // 功能         ：(单）多字节写
 191          // 参数         ：无
 192          // 返回值       ：0/1
 193          // 调用全局变量：无
 194          // 修改全局变量：无
 195          // 备注         ：
 196          //**************************************************************
 197          bit  Sif_Write_N_Byte(void)
 198          {
 199   1              unsigned char i;
 200   1              for(i=0;i<SIF_WDat_Num;i++)
 201   1                      {
 202   2                              send_byte(send_dat_buff[i]); //发送字节
 203   2                      
 204   2                              if(!sif_waitack())                      //判断是否有响应,如果没有响应，进入Stop
 205   2                                      {                                       
 206   3                                              send_stop();
 207   3                                              I2C_Usdelay(50);        
 208   3                                              return  (false);        //方便资料准备
 209   3                                              
 210   3                                      }                                       
 211   2                      }
 212   1              
 213   1                      send_stop();                                            //发送停止信号
 214   1               I2C_Usdelay(50);                                       //方便资料准备
 215   1               return (true);
 216   1                              
 217   1      }
 218          
 219          /*
 220          void main()
 221          {
 222                  RSTCFG = 0x20;
 223                  sif_init();                                               //SIF初始化
 224                  for(;;)
 225                  {                       
 226                          send_start();                           //SIF通讯start,写Nbyte，读Nbyte会用到
 227                          Sif_Write_N_Byte();                     //写N byte数据
 228                                  
 229                  }
 230          }
 231          */


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    119    ----
   CONSTANT SIZE    =   ----    ----
C51 COMPILER V9.01   MASTER_SIF                                                            01/07/2015 10:00:17 PAGE 5   

   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
